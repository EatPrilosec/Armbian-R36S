# This is a basic workflow to help you get started with Actions

name: release Armbian
on:
  workflow_dispatch:
env:
    GH_TOKEN: ${{ github.token }}

jobs:
  build:
    runs-on: ubuntu-latest
    steps:

      - name: Free Disk Space (Ubuntu)
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: true
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: true
          swap-storage: true
          
      - uses: actions/checkout@v4
      -
        name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Prep
        run: |
          export LatestArmbianVer=$(gh release list -R armbian/build |grep -v trunk | head -n1 |cut -f1)
          export LatestArmbianURL=https://github.com/armbian/build/archive/refs/tags/${LatestArmbianVer}.tar.gz
          echo LatestArmbianURL=$LatestArmbianURL
          wget -q -nv "$LatestArmbianURL" -O${LatestArmbianVer}.tar.gz
          tar --strip-components=1 -xf ${LatestArmbianVer}.tar.gz
          rm -f ${LatestArmbianVer}.tar.gz
          mkdir release

      - name: Build imgs
        run: |
          for image in r36-bookworm-gnome r36-bookworm-xfce r36-noble-gnome r36-noble-xfce; do
          ./compile.sh ${image} || exit 1
          find output -name "*.img" -exec cp -vf {} release/armbian-${image}.img \;
          done
          
      - name: Zip imgs
        run: |
          find release -name "*.img" -exec xz -vz -T0 -1 {} \;
          ls release

      - name: Release
        uses: softprops/action-gh-release@v2
        with:
          files: release/*.img.xz
          draft: true
